<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Documenta√ß√£o</title>
  <!-- Depend√™ncias globais necess√°rias para header/footer -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; }
    /* Estilo da consulta */
    .consulta-container { max-width: 700px; margin: 60px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .consulta-container h1 { text-align: center; margin-bottom: 30px; font-weight: 600; font-size: 24px; color: #003366; }
    .consulta-container label { font-weight: 500; display: block; margin-bottom: 8px; }
    .consulta-container input[type="text"] { width: 100%; padding: 10px; font-size: 16px; text-align: center; margin-bottom: 20px; border-radius: 6px; border: 1px solid #ccc; }
    .consulta-container button { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; color: white; background-color: #4a90e2; border: none; border-radius: 6px; cursor: pointer; }
    .consulta-container button:hover { background-color: #357ab8; }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background-color: #ffffff; margin-top: 30px; padding: 20px; }
    .data-section { margin-bottom: 30px; }
    .data-section h3 { font-size: 18px; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 5px; margin-bottom: 15px; }
    .data-section ul { list-style: none; padding: 0; }
    .data-section li { margin-bottom: 8px; }
    /* --- Estilo para abas e status --- */
    .tabs { display: flex; justify-content: center; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
    .tab-button { padding: 10px 20px; font-weight: bold; background-color: #e0e0e0; color: #003366; border: none; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; }
    .tab-button.active { background-color: #003366; color: #fff; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    .tab-content ul { list-style: none; padding-left: 0; margin-top: 10px; }
    .tab-content li { margin-bottom: 8px; font-size: 16px; line-height: 1.5; }
    li[data-status="COMPLETA"]::before { content: "‚úÖ "; color: green; }
    li[data-status="INCOMPLETA"]::before { content: "‚ö†Ô∏è "; color: orange; }
    li[data-status="PROTOCOLADA"]::before { content: "üìë "; color: teal; }
    li[data-status="EM FILA"]::before { content: "‚è≥ "; color: #007bff; }
    li[data-status*="LISTA"]::before { content: "üü¢ "; color: green; }
    li[data-status*="N√ÉO"]::before { content: "‚ùå "; color: red; }

    /* Avisos */
    .warning {
      background-color: #fff8e1;
      border-left: 6px solid #ffb300;
      color: #333;
      padding: 16px 20px;
      margin: 20px 0;
      font-size: 15px;
      line-height: 1.6;
      border-radius: 8px;
    }
/* Estilos m√≠nimos para o header carregado (igual ao diretoria.html) */
    header { background-color: #003366; padding: 20px; color: white; }
    nav { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .logo img { height: 50px; }
    nav ul { display: flex; list-style: none; gap: 20px; flex-wrap: wrap; }
    nav ul li { position: relative; }
    nav ul li a {
      color: white; text-decoration: none; font-weight: 600;
      padding: 8px 12px; display: block; transition: background-color 0.3s ease;
    }
    nav ul li a:hover { background-color: #005599; border-radius: 4px; }
    nav ul li ul {
      display: none; position: absolute; background-color: #004080;
      top: 100%; left: 0; min-width: 220px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 10;
    }
    nav ul li:hover ul { display: block; animation: fadeIn 0.3s ease-in-out; }
    nav ul li ul li a { padding: 10px; font-weight: 400; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(-8px);} to {opacity: 1; transform: translateY(0);} }
    @media (max-width: 768px) {
      nav ul { flex-direction: column; align-items: flex-start; }
    }

  </style>
</head>
<body>
  <!-- Header externo -->
  <div id="header-container"></div>

  <!-- CONTE√öDO PRINCIPAL -->
  <section style="padding: 60px 20px; background-color: #f4f6f9;">
    <div class="consulta-container">
      <h1>CONSULTA DE DOCUMENTA√á√ÉO</h1>
      <label for="cpfInput">Digite seu CPF:</label>
      <input id="cpfInput" placeholder="Digite seu CPF (com ou sem pontua√ß√£o)" type="text"/>
      <button id="consultBtn">CONSULTAR</button>
      <div id="resultContainer"></div>
    </div>
  </section>

  <section style="padding: 50px 20px; background-color: #003366; color: white; text-align: center;">
    <h2>Associe-se √† APIPMCBDF</h2>
    <p style="max-width: 700px; margin: 20px auto;">Junte-se a centenas de associados que t√™m seus direitos defendidos com firmeza e comprometimento. Seja representado, tenha acesso a benef√≠cios exclusivos e fa√ßa parte da nossa hist√≥ria!</p>
    <a href="seja-socio.html" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background-color: #f5b200; color: black; text-decoration: none; border-radius: 5px; font-weight: bold;">Quero me associar</a>
  </section>

  <section style="padding: 40px 20px; text-align: center; background-color: #fff;">
    <h2>Quem Somos</h2>
    <p style="max-width: 800px; margin: auto;">A APIPMCBDF representa e apoia os pensionistas e inativos da Pol√≠cia Militar e Corpo de Bombeiros do Antigo e Atual Distrito Federal. Lutamos por direitos, assist√™ncia e valoriza√ß√£o dos nossos associados.</p>
    <a href="sobre.html" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: #003366; color: white; text-decoration: none; border-radius: 5px;">Saiba mais</a>
  </section>

  <!-- Footer externo -->
  <div id="footer-container"></div>

  <!-- Includes de header e footer -->
  <script>
    (function loadHeader(){
      const el = document.getElementById('header-container');
      if (!el) return;
      fetch('header.html', { cache: 'no-store' })
        .then(r => r.text()).then(html => el.innerHTML = html)
        .catch(() => el.innerHTML = '<!-- falha ao carregar header -->');
    })();

    (function loadFooter(){
      const el = document.getElementById('footer-container');
      if (!el) return;
      fetch('footer.html', { cache: 'no-store' })
        .then(r => r.text()).then(html => el.innerHTML = html)
        .catch(() => el.innerHTML = '<!-- falha ao carregar footer -->');
    })();
    function toggleMenu() {
      var menu = document.getElementById("menu");
      if (menu) menu.classList.toggle("active");
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoXdgj_fRuYTluJby6QOIiEYBu268lZmQ",
      authDomain: "documentos-apipmcbdf.firebaseapp.com",
      projectId: "documentos-apipmcbdf",
      storageBucket: "documentos-apipmcbdf.appspot.com",
      messagingSenderId: "422508459389",
      appId: "1:422508459389:web:bebd6b53839f77a3cd4814"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    function formatarCPF(cpf) {
      return cpf.replace(/\D/g, '').padStart(11, '0');
    }

    function criarLista(campos, data) {
      const ul = document.createElement('ul');
      for (let campo of campos) {
        let valor = data[campo];
        if (!valor || !valor.toString().trim()) continue;

        let status = valor.toString().toUpperCase();

        // Renomeia "Status VPE"/"Status AUX" para "Pend√™ncias" se documenta√ß√£o estiver incompleta
        if ((campo === 'Status VPE' && (data['Documenta√ß√£o VPE'] || '').toUpperCase() === 'INCOMPLETA') ||
            (campo === 'Status AUX' && (data['Documenta√ß√£o AUX'] || '').toUpperCase() === 'INCOMPLETA')) {
          campo = 'Pend√™ncias';
        }

        // Renomeia "Recebe VPE" para "Lista de implanta√ß√£o" se estiver em uma das listas
        if (campo === 'Recebe VPE' && ['SEGUNDA LISTA DE IMPLANTA√á√ÉO VPE','TERCEIRA LISTA DE IMPLANTA√á√ÉO VPE','QUARTA LISTA DE IMPLANTA√á√ÉO VPE'].includes(status)) {
          campo = 'Lista de implanta√ß√£o';
        }

        const li = document.createElement('li');
        li.setAttribute('data-status', status);

        // Formata√ß√£o amig√°vel com quebra de linhas para pend√™ncias
        if (campo === 'Pend√™ncias') {
          const pendencias = valor.split(';').map(p => `<li>üìå ${p.trim()}</li>`).join('');
          li.innerHTML = `<strong>Pend√™ncias:</strong><ul style='margin-top:8px; padding-left: 18px;'>${pendencias}</ul>`;
        } else {
          li.textContent = `${campo}: ${valor}`;
        }
        ul.appendChild(li);
      }
      return ul.childElementCount ? ul : null;
    }

    function mostrarDados(data) {
      const container = document.getElementById('resultContainer');
      container.innerHTML = '';

      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = `<div class="card"><p style="padding:20px; text-align:center; font-weight:bold;">‚ùå Nenhum dado encontrado para este CPF.</p></div>`;
        return;
      }

      // Campos exportados na cole√ß√£o AuxMoradia
      const origem = data['ORIGEM'] ?? '';
      const nome = data['NOME'] ?? '';
      const cpf = data['CPF'] ?? '';
      const numProc = data['N√öMERO DE PROCESSO'] ?? '';
      const documentacao = data['DOCUMENTA√á√ÉO'] ?? '';
      const pendencias = data['PEND√äNCIAS'] ?? '';

      const card = document.createElement('div');
      card.className = 'card';

      const title = document.createElement('div');
      title.style.fontSize = '18px';
      title.style.fontWeight = '600';
      title.style.color = '#003366';
      title.style.marginBottom = '12px';
      title.textContent = 'Resultado da Consulta';
      card.appendChild(title);

      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.paddingLeft = '0';

      function addItem(label, value) {
        if (value === null || value === undefined) return;
        const v = value.toString().trim();
        if (!v) return;

        const li = document.createElement('li');
        li.style.marginBottom = '10px';

        const status = v.toUpperCase();
        li.setAttribute('data-status', status);

        if (label === 'PEND√äNCIAS') {
          const itens = v.split(';').map(p => p.trim()).filter(Boolean);
          if (itens.length === 0) return;

          li.innerHTML = `<strong>Pend√™ncias:</strong><ul style="margin-top:8px; padding-left: 18px;">${
            itens.map(p => `<li>üìå ${p}</li>`).join('')
          }</ul>`;
        } else {
          li.textContent = `${label}: ${v}`;
        }

        ul.appendChild(li);
      }

      addItem('ORIGEM', origem);
      addItem('NOME', nome);
      addItem('CPF', cpf || formatarCPF(document.getElementById('cpfInput').value));
      addItem('N√öMERO DE PROCESSO', numProc);
      addItem('DOCUMENTA√á√ÉO', documentacao);
      addItem('PEND√äNCIAS', pendencias);

      card.appendChild(ul);

      // Aviso simples para documenta√ß√£o incompleta
      const docUpper = (documentacao || '').toString().toUpperCase();
      if (docUpper === 'INCOMPLETA' || docUpper === 'NCOMPLETA') {
        const avisoDiv = document.createElement('div');
        avisoDiv.className = 'warning';
        avisoDiv.innerHTML = `üì¢ Aten√ß√£o: sua documenta√ß√£o consta como <strong>INCOMPLETA</strong>. Se houver pend√™ncias listadas acima, encaminhe os documentos pendentes conforme orienta√ß√£o da associa√ß√£o.`;
        card.appendChild(avisoDiv);
      }

      container.appendChild(card);
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('consultBtn').onclick = async () => {
        const raw = document.getElementById('cpfInput').value;
        const cpf = formatarCPF(raw);
        if (cpf.length !== 11) { alert('CPF inv√°lido'); return; }

        try {
          const ref = doc(db, 'AuxMoradia', cpf);
          const snap = await getDoc(ref);
          mostrarDados(snap.exists() ? snap.data() : {});
        } catch (err) {
          console.error(err);

          const container = document.getElementById('resultContainer');
          const msg = (err && err.message) ? err.message : String(err);

          // Mensagem amig√°vel para erro de permiss√£o
          if (msg.toLowerCase().includes('missing or insufficient permissions')) {
            container.innerHTML = `
              <div class="card">
                <p style="padding:18px; text-align:center; font-weight:700;">‚ùå Permiss√£o insuficiente para consultar o banco.</p>
                <p style="padding:0 18px 18px; text-align:center; opacity:.85;">
                  Isso acontece quando as <strong>Regras do Firestore</strong> n√£o permitem leitura para este site.
                  <br/>Solu√ß√£o: liberar leitura para usu√°rios autenticados ou publicar o site com autentica√ß√£o.
                </p>
              </div>`;
            return;
          }

          container.innerHTML = `
            <div class="card">
              <p style="padding:18px; text-align:center; font-weight:700;">‚ùå Erro ao consultar.</p>
              <p style="padding:0 18px 18px; text-align:center; opacity:.85;">${msg}</p>
            </div>`;
        }
      };
    });
  </script>
  <noscript>
    <iframe src="header.html" title="Cabe√ßalho" style="width:100%; border:0; height:160px;"></iframe>
    <iframe src="footer.html" title="Rodap√©" style="width:100%; border:0; height:320px;"></iframe>
  </noscript>

</body>
</html>
